#!/usr/bin/env python3

# The original author of this program, "till", is StarBrilliant.
# This file is released under General Public License version 3.
# You should have received a copy of General Public License text alongside with
# this program. If not, you can obtain it at http://gnu.org/copyleft/gpl.html .
# This program comes with no warranty, the author will not be resopnsible for
# any damage or problems caused by this program.

import math
import os
import sys
import time
import parsedatetime  # https://pypi.python.org/pypi/parsedatetime


def format_time(unix_time):
    return time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(unix_time)) + '.%09.0f' % ((unix_time - math.floor(unix_time)) * 1000000000)


def main():
    if len(sys.argv) < 3:
        sys.stdout.write(
            'Usage: %s TIME[.FRAC] COMMAND [ARGS ...]\n'
            '\n'
            'This program will wait until TIME, then execute COMMAND.'
            '\n'
            'TIME is a time specification that is understood by python-dateparser.\n'
            'FRAC may be a number to specify a time more precise than a second.\n\n'
            'Warning: This program is not garanteed to be DST aware or leap second aware.\n\n'
        )
        return

    if '.' in sys.argv[1]:
        spec, frac = sys.argv[1].rsplit('.', 1)
    else:
        spec, frac = sys.argv[1], None
    preset, confidence = parsedatetime.Calendar().parse(spec)
    if confidence == 0:
        sys.stderr.write('Invalid time specification: %s\n' % sys.argv[1])
        sys.exit(1)
    if frac:
        if frac[0] != '-':
            frac = float('.' + frac)
        else:
            frac = float('-.' + frac[1:])
    else:
        frac = 0
    preset = time.mktime(preset) + frac
    sys.stderr.write('Preset: %s\n' % format_time(preset))

    while True:
        now = time.time()
        if now >= preset:
            sys.stderr.write('Now:    %s\nExecuting %s\n\n' % (format_time(now), ' '.join(sys.argv[2:])))
            os.execvp(sys.argv[2], sys.argv[2:])
            assert OSError('can not exec %s' % sys.argv[2])

        delta = preset - now
        if delta >= 2.0:
            sys.stderr.write('Check:  %s\n' % format_time(now))
            time.sleep(int(delta)//2)
        elif delta >= 0.05:
            time.sleep(delta/2)


if __name__ == '__main__':
    main()
